<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>阿順與秦佳圓的記帳本</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 全局設定 */
        body { 
            -webkit-tap-highlight-color: transparent; 
            background-color: #f3f4f6; 
            font-family: 'Noto Sans TC', system-ui, sans-serif;
            color: #334155;
        }
        
        /* 表格專用字體 (等寬數字) */
        .font-tabular { 
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; 
            font-variant-numeric: tabular-nums; 
            letter-spacing: -0.5px;
        }

        /* 高密度表格樣式 */
        .dense-table-row {
            display: grid;
            grid-template-columns: 2.8rem 1fr auto 4rem; /* 日期 | 內容 | 金額 | 餘額 */
            gap: 0.5rem;
            align-items: center;
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            transition: background 0.2s;
        }
        .dense-table-row:active { background-color: #f1f5f9; }
        .dense-table-row:last-child { border-bottom: none; }

        /* 膠囊標籤 */
        .pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            height: 20px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 4px;
        }
        .pill-sm { background-color: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; } /* 小瓶 */
        .pill-lg { background-color: #fefce8; color: #b45309; border: 1px solid #fef9c3; } /* 大瓶 */

        /* 數字顏色 */
        .num-pos { color: #475569; } /* 一般 */
        .num-neg { color: #be123c; } /* 負數 (Rose-700) */
        .num-dep { color: #4338ca; } /* 儲值 (Indigo-700) */

        /* 餘額狀態 */
        .balance-bg { background: linear-gradient(135deg, #4c1d95 0%, #6d28d9 100%); }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col overflow-hidden">

<div id="app" class="flex flex-col h-full max-w-lg mx-auto bg-white shadow-2xl relative">

    <header class="balance-bg text-white pt-6 pb-4 px-5 shadow-lg z-20 shrink-0">
        <div class="flex justify-between items-start mb-1">
            <div>
                <h1 class="text-sm text-indigo-200 font-medium tracking-wide">阿順與秦佳圓的記帳本</h1>
                <div class="flex items-baseline gap-2 mt-1">
                    <span class="text-4xl font-bold font-tabular tracking-tight">
                        ${{ formatNumber(currentBalance) }}
                    </span>
                    <span class="text-xs bg-white/20 px-2 py-0.5 rounded text-indigo-100">目前餘額</span>
                </div>
            </div>
            <div class="text-right">
                <span v-if="dbReady" class="text-xs text-green-300 font-bold"><i class="fa-solid fa-wifi"></i> 連線正常</span>
                <span v-else class="text-xs text-indigo-300"><i class="fa-solid fa-circle-notch fa-spin"></i> 同步中</span>
                <div class="text-[10px] text-indigo-300 mt-1">{{ dateRangeStr }}</div>
            </div>
        </div>
    </header>

    <div class="bg-slate-50 border-b border-slate-200 px-2 py-2 text-xs font-bold text-slate-500 grid grid-cols-[2.8rem_1fr_auto_4rem] gap-2 shrink-0 z-10">
        <div class="text-center">日期</div>
        <div>項目明細</div>
        <div class="text-right">收支</div>
        <div class="text-right pr-1">結餘</div>
    </div>

    <main class="flex-1 overflow-y-auto bg-slate-50 pb-24 scroll-smooth">
        
        <div v-if="transactions.length === 0 && dbReady" class="p-8 flex flex-col items-center justify-center h-full opacity-80">
            <i class="fa-solid fa-file-csv text-6xl text-slate-300 mb-4"></i>
            <p class="text-slate-500 mb-6 font-medium">資料庫目前是空的</p>
            <button @click="importInitialData" class="bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-lg font-bold active:scale-95 transition-transform flex items-center gap-2">
                <i class="fa-solid fa-cloud-arrow-up"></i> 一鍵導入整理好的帳本
            </button>
        </div>

        <template v-for="(group, monthKey) in groupedTransactions" :key="monthKey">
            <div class="sticky top-0 bg-slate-200/90 backdrop-blur text-slate-600 text-xs font-bold px-3 py-1 border-y border-slate-300 shadow-sm z-0 flex justify-between">
                <span>{{ monthKey }}</span>
                <span>月結: ${{ formatNumber(group.endBalance) }}</span>
            </div>

            <div v-for="t in group.items" :key="t.id" class="dense-table-row relative group">
                <div class="flex flex-col items-center leading-tight">
                    <span class="text-sm font-bold text-slate-700">{{ getDay(t.date) }}</span>
                    <span class="text-[10px] text-slate-400">{{ getWeekDay(t.date) }}</span>
                </div>

                <div class="overflow-hidden">
                    <div v-if="t.type === 'expense'" class="flex items-center flex-wrap gap-y-1">
                        <span v-if="t.small > 0" class="pill pill-sm">小{{ t.small }}</span>
                        <span v-if="t.large > 0" class="pill pill-lg">大{{ t.large }}</span>
                        <span v-if="t.note" class="text-xs text-slate-400 ml-1 truncate">{{ t.note }}</span>
                    </div>
                    <div v-else class="flex items-center">
                        <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100">
                            <i class="fa-solid fa-arrow-turn-down mr-1"></i>儲值
                        </span>
                        <span v-if="t.note" class="text-xs text-slate-400 ml-2 truncate">{{ t.note }}</span>
                    </div>
                </div>

                <div class="text-right font-tabular font-bold text-sm">
                    <span :class="t.type === 'deposit' ? 'num-dep' : 'num-neg'">
                        {{ t.type === 'deposit' ? '+' : '-' }}{{ t.amount }}
                    </span>
                </div>

                <div class="text-right font-tabular text-sm font-medium text-slate-600 pr-1">
                    {{ formatNumber(t.balance) }}
                </div>

                <button @click="deleteTransaction(t.id)" class="absolute right-0 top-0 bottom-0 w-12 bg-red-500 text-white opacity-0 active:opacity-100 flex items-center justify-center transition-opacity">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        </template>
        
        <div class="h-6"></div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-3 pb-6 z-30 flex gap-3 max-w-lg mx-auto shadow-[0_-4px_10px_rgba(0,0,0,0.05)]">
        <button @click="openModal('expense')" class="flex-1 bg-[#6B46C1] active:bg-[#553C9A] text-white py-3 rounded-lg font-bold text-lg shadow-md flex justify-center items-center gap-2 transition-transform active:scale-95">
            <i class="fa-solid fa-truck"></i> 配送記帳
        </button>
        <button @click="openModal('deposit')" class="flex-[0.6] bg-[#475569] active:bg-[#334155] text-white py-3 rounded-lg font-bold text-lg shadow-md flex justify-center items-center gap-2 transition-transform active:scale-95">
            <i class="fa-solid fa-wallet"></i> 儲值
        </button>
    </div>

    <div v-if="showModal" class="fixed inset-0 bg-slate-900/60 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full max-w-lg rounded-t-2xl sm:rounded-2xl p-5 shadow-2xl animate-slide-up">
            
            <div class="flex justify-between items-center mb-5 border-b border-slate-100 pb-3">
                <h2 class="text-xl font-bold text-slate-700 flex items-center gap-2">
                    <span class="w-2 h-6 rounded-full" :class="modalType === 'expense' ? 'bg-[#6B46C1]' : 'bg-[#475569]'"></span>
                    {{ modalType === 'expense' ? '新增配送' : '新增儲值' }}
                </h2>
                <button @click="showModal = false" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center hover:bg-slate-200">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div class="flex items-center bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <input type="date" v-model="form.date" class="bg-transparent text-lg font-bold text-slate-700 outline-none flex-1 font-tabular">
                    <span class="text-slate-400 font-medium px-2 border-l border-slate-200 ml-2">
                        {{ getWeekDay(form.date) }}
                    </span>
                </div>

                <div v-if="modalType === 'expense'" class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50/50 p-3 rounded-lg border border-blue-100">
                        <label class="block text-xs font-bold text-blue-600 mb-2">小羊奶 ($70)</label>
                        <div class="flex items-center justify-between">
                            <button @click="form.small = Math.max(0, form.small-1)" class="w-10 h-10 rounded bg-white text-blue-600 shadow-sm border border-blue-100 font-bold text-xl hover:bg-blue-50">-</button>
                            <span class="text-2xl font-bold font-tabular text-blue-800">{{ form.small }}</span>
                            <button @click="form.small++" class="w-10 h-10 rounded bg-blue-600 text-white shadow-md font-bold text-xl hover:bg-blue-700 active:scale-95 transition">+</button>
                        </div>
                    </div>
                    <div class="bg-amber-50/50 p-3 rounded-lg border border-amber-100">
                        <label class="block text-xs font-bold text-amber-700 mb-2">大羊奶 ($130)</label>
                        <div class="flex items-center justify-between">
                            <button @click="form.large = Math.max(0, form.large-1)" class="w-10 h-10 rounded bg-white text-amber-600 shadow-sm border border-amber-100 font-bold text-xl hover:bg-amber-50">-</button>
                            <span class="text-2xl font-bold font-tabular text-amber-800">{{ form.large }}</span>
                            <button @click="form.large++" class="w-10 h-10 rounded bg-amber-500 text-white shadow-md font-bold text-xl hover:bg-amber-600 active:scale-95 transition">+</button>
                        </div>
                    </div>
                </div>

                <div v-if="modalType === 'deposit'">
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xl font-bold">$</span>
                        <input type="number" inputmode="numeric" v-model.number="form.amount" class="w-full pl-8 pr-4 py-4 bg-slate-50 border border-slate-200 rounded-lg text-3xl font-bold text-slate-700 outline-none focus:border-indigo-500 font-tabular placeholder-slate-300" placeholder="0">
                    </div>
                    <div class="flex gap-2 mt-3 overflow-x-auto pb-1">
                        <button @click="form.amount = 1000" class="px-4 py-2 bg-slate-100 rounded text-slate-600 font-bold text-sm border border-slate-200">+1000</button>
                        <button @click="form.amount = 2000" class="px-4 py-2 bg-slate-100 rounded text-slate-600 font-bold text-sm border border-slate-200">+2000</button>
                        <button @click="form.amount = 4000" class="px-4 py-2 bg-slate-100 rounded text-slate-600 font-bold text-sm border border-slate-200">+4000</button>
                    </div>
                </div>

                <div class="flex gap-3">
                    <input type="text" v-model="form.note" class="flex-1 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-indigo-300" placeholder="備註 (選填)">
                    <div v-if="modalType === 'expense'" class="flex items-center px-3 bg-slate-100 rounded-lg">
                        <span class="text-xs text-slate-500 mr-2">小計</span>
                        <span class="font-bold text-lg text-slate-700 font-tabular">${{ calculateExpense() }}</span>
                    </div>
                </div>

                <button @click="submitTransaction" class="w-full py-3.5 mt-2 rounded-lg font-bold text-lg text-white shadow-md transition-transform active:scale-[0.98]" :class="modalType === 'expense' ? 'bg-[#6B46C1] hover:bg-[#553C9A]' : 'bg-[#475569] hover:bg-[#334155]'">
                    確認存檔
                </button>
            </div>
            <div class="h-4 sm:h-0"></div>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { createApp, ref, computed, onMounted } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB6D9vh6J2mdnjz2VXEVe99oi7oLF-irFo",
        authDomain: "crm-ts-1225-001.firebaseapp.com",
        databaseURL: "https://crm-ts-1225-001-default-rtdb.firebaseio.com",
        projectId: "crm-ts-1225-001",
        storageBucket: "crm-ts-1225-001.firebasestorage.app",
        messagingSenderId: "925760221722",
        appId: "1:925760221722:web:1aeda0b82f1f16b8dcd7a3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COLLECTION_NAME = "milk_ledger_v2"; // 使用新表避免衝突

    createApp({
        setup() {
            const dbReady = ref(false);
            const rawTransactions = ref([]);
            const showModal = ref(false);
            const modalType = ref('expense');
            const prices = ref({ small: 70, large: 130 }); // 目前定價

            const form = ref({
                date: new Date().toISOString().split('T')[0],
                small: 0,
                large: 0,
                amount: '',
                note: ''
            });

            // 整理後的完整歷史數據 (Excel 邏輯，去除重複，剔除 9/30 3400)
            const initialData = [
                {date: '2025-03-12', type: 'expense', small: 4, large: 0, amount: 260, note: '初始'},
                {date: '2025-03-16', type: 'expense', small: 17, large: 0, amount: 1105, note: '3/21已付'},
                {date: '2025-03-23', type: 'expense', small: 6, large: 0, amount: 390, note: ''},
                {date: '2025-03-30', type: 'expense', small: 4, large: 1, amount: 395, note: '小65大135'},
                {date: '2025-04-12', type: 'expense', small: 10, large: 0, amount: 650, note: ''},
                {date: '2025-04-21', type: 'expense', small: 5, large: 0, amount: 325, note: ''},
                {date: '2025-04-30', type: 'deposit', small: 0, large: 0, amount: 3000, note: '轉帳'},
                {date: '2025-05-01', type: 'expense', small: 4, large: 0, amount: 260, note: ''},
                {date: '2025-05-04', type: 'expense', small: 8, large: 0, amount: 520, note: ''},
                {date: '2025-05-12', type: 'expense', small: 10, large: 0, amount: 650, note: ''},
                {date: '2025-05-24', type: 'expense', small: 10, large: 0, amount: 650, note: ''},
                {date: '2025-06-01', type: 'expense', small: 11, large: 0, amount: 715, note: ''},
                {date: '2025-06-08', type: 'expense', small: 7, large: 0, amount: 455, note: ''},
                {date: '2025-06-08', type: 'deposit', small: 0, large: 0, amount: 4000, note: '儲值'},
                {date: '2025-06-15', type: 'expense', small: 7, large: 0, amount: 455, note: ''},
                {date: '2025-06-24', type: 'expense', small: 1, large: 0, amount: 65, note: ''},
                {date: '2025-06-28', type: 'expense', small: 5, large: 0, amount: 325, note: ''},
                {date: '2025-07-06', type: 'expense', small: 4, large: 0, amount: 260, note: ''},
                {date: '2025-07-20', type: 'expense', small: 4, large: 0, amount: 260, note: ''},
                {date: '2025-07-29', type: 'expense', small: 4, large: 0, amount: 260, note: ''},
                {date: '2025-08-01', type: 'expense', small: 2, large: 0, amount: 130, note: ''},
                {date: '2025-08-01', type: 'deposit', small: 0, large: 0, amount: 1290, note: '補餘額'},
                {date: '2025-08-12', type: 'expense', small: 10, large: 0, amount: 650, note: ''},
                {date: '2025-08-17', type: 'expense', small: 4, large: 0, amount: 280, note: '漲價'},
                {date: '2025-08-21', type: 'expense', small: 2, large: 0, amount: 140, note: ''},
                {date: '2025-08-28', type: 'expense', small: 3, large: 0, amount: 210, note: ''},
                {date: '2025-08-28', type: 'deposit', small: 0, large: 0, amount: 1280, note: ''},
                {date: '2025-09-01', type: 'expense', small: 2, large: 0, amount: 140, note: ''},
                {date: '2025-09-06', type: 'expense', small: 5, large: 0, amount: 350, note: ''},
                {date: '2025-09-16', type: 'expense', small: 4, large: 0, amount: 280, note: ''},
                {date: '2025-09-22', type: 'expense', small: 2, large: 0, amount: 140, note: ''},
                {date: '2025-09-30', type: 'expense', small: 6, large: 2, amount: 680, note: ''},
                {date: '2025-09-30', type: 'deposit', small: 0, large: 0, amount: 5000, note: '轉帳'},
                {date: '2025-10-03', type: 'expense', small: 4, large: 0, amount: 280, note: ''},
                {date: '2025-10-12', type: 'expense', small: 6, large: 3, amount: 810, note: ''},
                {date: '2025-10-19', type: 'expense', small: 7, large: 3, amount: 880, note: ''},
                {date: '2025-10-19', type: 'deposit', small: 0, large: 0, amount: 3959, note: ''},
                {date: '2025-10-27', type: 'expense', small: 6, large: 4, amount: 940, note: ''},
                {date: '2025-11-03', type: 'expense', small: 10, large: 5, amount: 1350, note: ''},
                {date: '2025-11-03', type: 'deposit', small: 0, large: 0, amount: 1200, note: ''},
                {date: '2025-11-10', type: 'expense', small: 0, large: 4, amount: 520, note: ''},
                {date: '2025-11-17', type: 'expense', small: 11, large: 3, amount: 1160, note: ''},
                {date: '2025-11-17', type: 'deposit', small: 0, large: 0, amount: 4000, note: ''},
                {date: '2025-11-24', type: 'expense', small: 4, large: 6, amount: 1060, note: ''},
                {date: '2025-12-01', type: 'expense', small: 4, large: 4, amount: 800, note: ''},
                {date: '2025-12-06', type: 'expense', small: 13, large: 3, amount: 1300, note: ''},
                {date: '2025-12-09', type: 'expense', small: 2, large: 0, amount: 140, note: ''},
                {date: '2025-12-28', type: 'expense', small: 11, large: 4, amount: 1290, note: ''},
                {date: '2026-01-03', type: 'expense', small: 12, large: 0, amount: 840, note: ''},
                {date: '2026-01-03', type: 'deposit', small: 0, large: 0, amount: 4200, note: ''},
                {date: '2026-01-04', type: 'expense', small: 6, large: 0, amount: 420, note: ''}
            ];

            onMounted(() => {
                const q = query(collection(db, COLLECTION_NAME), orderBy("date", "desc"));
                onSnapshot(q, (snapshot) => {
                    rawTransactions.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    dbReady.value = true;
                });
            });

            // 核心邏輯：動態計算餘額 (按日期升序計算，再反轉顯示)
            const transactions = computed(() => {
                const sortedAsc = [...rawTransactions.value].sort((a, b) => new Date(a.date) - new Date(b.date));
                let runningBalance = 0;
                
                return sortedAsc.map(t => {
                    const amount = t.type === 'deposit' ? Number(t.amount) : -Number(t.amount);
                    runningBalance += amount;
                    return { ...t, balance: runningBalance };
                }).reverse(); // UI 顯示新到舊
            });

            const currentBalance = computed(() => transactions.value.length > 0 ? transactions.value[0].balance : 0);

            // 分組顯示邏輯
            const groupedTransactions = computed(() => {
                const groups = {};
                transactions.value.forEach(t => {
                    const d = new Date(t.date);
                    const key = `${d.getFullYear()}.${d.getMonth() + 1}`;
                    if (!groups[key]) {
                        groups[key] = { items: [], endBalance: null };
                    }
                    if (groups[key].endBalance === null) groups[key].endBalance = t.balance; // 該月第一筆即為月底餘額
                    groups[key].items.push(t);
                });
                return groups;
            });

            const dateRangeStr = computed(() => {
                if (transactions.value.length === 0) return '';
                const end = transactions.value[0].date;
                const start = transactions.value[transactions.value.length-1].date;
                return `${start} ~ ${end}`;
            });

            // 輔助格式化
            const formatNumber = (num) => num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            const getWeekDay = (dateStr) => `(${['日','一','二','三','四','五','六'][new Date(dateStr).getDay()]})`;
            const getDay = (dateStr) => {
                const d = new Date(dateStr);
                return `${d.getMonth()+1}/${d.getDate()}`;
            };

            const openModal = (type) => {
                modalType.value = type;
                form.value = { date: new Date().toISOString().split('T')[0], small: 0, large: 0, amount: '', note: '' };
                showModal.value = true;
            };

            const calculateExpense = () => (form.value.small * prices.value.small) + (form.value.large * prices.value.large);

            const submitTransaction = async () => {
                if (modalType.value === 'deposit' && !form.value.amount) return alert("請輸入金額");
                if (modalType.value === 'expense' && calculateExpense() === 0) return alert("請輸入數量");

                const newTx = {
                    date: form.value.date,
                    type: modalType.value,
                    small: modalType.value === 'expense' ? form.value.small : 0,
                    large: modalType.value === 'expense' ? form.value.large : 0,
                    amount: modalType.value === 'expense' ? calculateExpense() : form.value.amount,
                    note: form.value.note,
                    timestamp: Date.now()
                };

                await addDoc(collection(db, COLLECTION_NAME), newTx);
                showModal.value = false;
            };

            const deleteTransaction = async (id) => {
                if(confirm('確定要刪除這筆紀錄嗎？')) await deleteDoc(doc(db, COLLECTION_NAME, id));
            };

            const importInitialData = async () => {
                if(!confirm(`即將導入 ${initialData.length} 筆歷史資料，確定嗎？`)) return;
                const promises = initialData.map(data => addDoc(collection(db, COLLECTION_NAME), { ...data, timestamp: Date.now() }));
                await Promise.all(promises);
                alert("導入完成！");
            };

            return {
                dbReady, showModal, modalType, form, 
                transactions, groupedTransactions, currentBalance, dateRangeStr,
                formatNumber, getWeekDay, getDay,
                openModal, calculateExpense, submitTransaction, deleteTransaction, importInitialData
            };
        }
    }).mount('#app');
</script>
</body>
</html>